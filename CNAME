<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Мой план на год</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #111827;
      color: #e5e7eb;
    }
    header {
      padding: 10px 16px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    button, select, input, textarea {
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
    }
    button {
      cursor: pointer;
    }
    button.active {
      background: #4b5563;
    }
    main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 16px 40px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .month-label {
      font-weight: 600;
    }

    /* Переключение видов */
    .view-switch button {
      min-width: 70px;
    }

    /* Календарный вид */
    .calendar {
      display: none;
      border-radius: 8px;
      border: 1px solid #374151;
      overflow: hidden;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #020617;
    }
    .weekday {
      padding: 6px 4px;
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
      border-bottom: 1px solid #1f2937;
    }
    .day-cell {
      min-height: 70px;
      border: 1px solid #111827;
      padding: 4px;
      font-size: 11px;
      vertical-align: top;
      cursor: pointer;
      background: #020617;
    }
    .day-number {
      font-weight: 600;
      margin-bottom: 2px;
      color: #d1d5db;
    }
    .day-cell.other-month .day-number {
      color: #4b5563;
    }
    .event-tag {
      display: block;
      margin-top: 1px;
      padding: 1px 3px;
      border-radius: 3px;
      font-size: 10px;
      background: #4b5563;
      color: #e5e7eb;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* Табличный вид */
    .table-view {
      display: none;
      border-radius: 8px;
      border: 1px solid #374151;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 4px 6px;
      vertical-align: top;
    }
    th {
      background: #020617;
      text-align: left;
    }
    .day-col {
      width: 80px;
      white-space: nowrap;
    }
    .events-col div {
      margin-bottom: 2px;
    }
    .events-col span.time {
      color: #93c5fd;
      margin-right: 4px;
    }

    /* Панель редактирования */
    .editor-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #065f46;
      color: #ecfdf5;
    }

    .editor-panel {
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 8px;
      display: none;
      gap: 8px;
      background: #020617;
    }
    .editor-panel-inner {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .editor-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .editor-row label {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .editor-row input[type="time"],
    .editor-row input[type="text"] {
      width: 160px;
    }
    textarea {
      width: 100%;
      min-height: 40px;
      resize: vertical;
    }
    .small-note {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Шаблоны */
    .template-name-input {
      width: 160px;
    }
    .template-color-input {
      width: 80px;
      padding: 0;
      height: 26px;
    }

    /* Мелкая адаптация под телефон */
    @media (max-width: 640px) {
      .day-cell {
        min-height: 60px;
        padding: 2px;
        font-size: 10px;
      }
      header h1 {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Мой план на год</h1>
  <div class="controls">
    <button id="editorToggleBtn">Войти как редактор</button>
  </div>
</header>

<main>
  <div class="top-bar">
    <div class="month-nav">
      <button id="prevMonthBtn">&lt;</button>
      <div class="month-label" id="monthLabel"></div>
      <button id="nextMonthBtn">&gt;</button>
    </div>
    <div class="view-switch">
      <button id="calendarViewBtn" class="active">Календарь</button>
      <button id="tableViewBtn">Таблица</button>
    </div>
  </div>

  <div class="editor-bar">
    <span id="editorStatus" class="small-note">Режим просмотра (редактирование выключено).</span>
    <span id="editorBadge" class="badge" style="display:none;">Редактор</span>
  </div>

  <div class="calendar" id="calendarView">
    <div class="calendar-grid" id="calendarGrid">
      <!-- сюда JS нарисует дни -->
    </div>
  </div>

  <div class="table-view" id="tableView">
    <table>
      <thead>
      <tr>
        <th class="day-col">Дата</th>
        <th>События</th>
      </tr>
      </thead>
      <tbody id="tableBody">
      <!-- сюда JS нарисует строки -->
      </tbody>
    </table>
  </div>

  <div class="editor-panel" id="editorPanel">
    <div class="editor-panel-inner">
      <div class="small-note" id="currentDayLabel">День не выбран.</div>
      <div class="editor-row">
        <label>
          Шаблон
          <select id="templateSelect"></select>
        </label>
        <button id="addTemplateBtn">+ шаблон</button>
        <button id="removeTemplateBtn">Удалить шаблон</button>
      </div>
      <div class="editor-row">
        <label>
          Название
          <input type="text" id="eventTitleInput">
        </label>
        <label>
          Время
          <input type="time" id="eventTimeInput">
        </label>
      </div>
      <label>
        Комментарий
        <textarea id="eventCommentInput"></textarea>
      </label>
      <div class="editor-row">
        <button id="saveEventBtn">Сохранить событие</button>
        <button id="clearDayBtn">Удалить все события дня</button>
      </div>
      <hr>
      <div class="editor-row">
        <label>
          Название шаблона
          <input type="text" id="templateNameInput" class="template-name-input">
        </label>
        <label>
          Цвет
          <input type="color" id="templateColorInput" class="template-color-input" value="#4b5563">
        </label>
        <button id="saveTemplateBtn">Сохранить шаблон</button>
      </div>
      <div class="small-note">
        Шаблоны задают цвет и базовое название. При выборе шаблона можно менять название, время и комментарий.
      </div>
    </div>
  </div>
</main>

<script>
  // ========= НАСТРОЙКИ =========
  const EDITOR_PASSWORD = "1234"; // ПОМЕНЯЙ ПАРОЛЬ ЗДЕСЬ

  const STORAGE_KEY_EVENTS = "myScheduleEvents_v1";
  const STORAGE_KEY_TEMPLATES = "myScheduleTemplates_v1";

  // не больше года от текущей даты
  const MIN_YEAR_OFFSET = 0;   // текущий год
  const MAX_YEAR_OFFSET = 1;   // +1 год

  const monthLabelEl = document.getElementById("monthLabel");
  const calendarGridEl = document.getElementById("calendarGrid");
  const tableBodyEl = document.getElementById("tableBody");
  const calendarViewEl = document.getElementById("calendarView");
  const tableViewEl = document.getElementById("tableView");
  const calendarViewBtn = document.getElementById("calendarViewBtn");
  const tableViewBtn = document.getElementById("tableViewBtn");
  const prevMonthBtn = document.getElementById("prevMonthBtn");
  const nextMonthBtn = document.getElementById("nextMonthBtn");
  const editorToggleBtn = document.getElementById("editorToggleBtn");
  const editorStatusEl = document.getElementById("editorStatus");
  const editorBadgeEl = document.getElementById("editorBadge");
  const editorPanelEl = document.getElementById("editorPanel");
  const currentDayLabelEl = document.getElementById("currentDayLabel");

  const templateSelectEl = document.getElementById("templateSelect");
  const addTemplateBtn = document.getElementById("addTemplateBtn");
  const removeTemplateBtn = document.getElementById("removeTemplateBtn");
  const eventTitleInput = document.getElementById("eventTitleInput");
  const eventTimeInput = document.getElementById("eventTimeInput");
  const eventCommentInput = document.getElementById("eventCommentInput");
  const saveEventBtn = document.getElementById("saveEventBtn");
  const clearDayBtn = document.getElementById("clearDayBtn");
  const templateNameInput = document.getElementById("templateNameInput");
  const templateColorInput = document.getElementById("templateColorInput");
  const saveTemplateBtn = document.getElementById("saveTemplateBtn");

  const weekdayShort = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
  const monthNames = [
    "Январь","Февраль","Март","Апрель","Май","Июнь",
    "Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"
  ];

  let currentDate = new Date();
  let currentMonth = currentDate.getMonth();
  let currentYear = currentDate.getFullYear();

  let events = loadEvents();
  let templates = loadTemplates();
  let isEditor = false;
  let selectedDay = null; // {year, month, date}

  // ========= ЗАГРУЗКА / СОХРАНЕНИЕ =========
  function loadEvents() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_EVENTS);
      if (!raw) return {};
      return JSON.parse(raw);
    } catch (e) {
      console.error("Error loading events", e);
      return {};
    }
  }
  function saveEvents() {
    localStorage.setItem(STORAGE_KEY_EVENTS, JSON.stringify(events));
  }

  function loadTemplates() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_TEMPLATES);
      if (!raw) {
        // дефолтные шаблоны
        const defaults = [
          { id: "study", name: "Учёба", color: "#2563eb" },
          { id: "work", name: "Работа", color: "#16a34a" },
          { id: "sport", name: "Спорт", color: "#f97316" }
        ];
        localStorage.setItem(STORAGE_KEY_TEMPLATES, JSON.stringify(defaults));
        return defaults;
      }
      return JSON.parse(raw);
    } catch (e) {
      console.error("Error loading templates", e);
      return [];
    }
  }
  function saveTemplates() {
    localStorage.setItem(STORAGE_KEY_TEMPLATES, JSON.stringify(templates));
  }

  // ========= ВСПОМОГАТЕЛЬНЫЕ =========

  // ключ дня: YYYY-MM-DD
  function dayKey(year, month, day) {
    const mm = String(month + 1).padStart(2, "0");
    const dd = String(day).padStart(2, "0");
    return year + "-" + mm + "-" + dd;
  }

  function clampYearMonth(year, month) {
    const now = new Date();
    const minYear = now.getFullYear() + MIN_YEAR_OFFSET;
    const maxYear = now.getFullYear() + MAX_YEAR_OFFSET;
    if (year < minYear) year = minYear;
    if (year > maxYear) year = maxYear;
    return { year, month };
  }

  function getTemplateById(id) {
    return templates.find(t => t.id === id) || null;
  }

  function refreshTemplateSelect() {
    templateSelectEl.innerHTML = "";
    if (!templates.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "нет шаблонов";
      templateSelectEl.appendChild(opt);
      return;
    }
    templates.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      templateSelectEl.appendChild(opt);
    });
  }

  function formatDateLabel(year, month, day) {
    return `${day} ${monthNames[month]} ${year}`;
  }

  // ========= ОТРИСОВКА КАЛЕНДАРЯ =========
  function renderCalendar(month, year) {
    monthLabelEl.textContent = `${monthNames[month]} ${year}`;
    calendarGridEl.innerHTML = "";

    // шапка дней недели
    weekdayShort.forEach(wd => {
      const div = document.createElement("div");
      div.className = "weekday";
      div.textContent = wd;
      calendarGridEl.appendChild(div);
    });

    const firstDay = new Date(year, month, 1);
    const startingDay = (firstDay.getDay() + 6) % 7; // делаем Пн=0
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();

    // всего ячеек: 6 недель * 7 дней = 42
    let dayNum = 1;
    let nextMonthDay = 1;

    for (let i = 0; i < 6 * 7; i++) {
      const cell = document.createElement("div");
      cell.className = "day-cell";

      let cellDay, cellMonth = month, cellYear = year;
      if (i < startingDay) {
        // дни прошлого месяца
        cellDay = daysInPrevMonth - (startingDay - i - 1);
        cellMonth = month - 1;
        if (cellMonth < 0) {
          cellMonth = 11;
          cellYear = year - 1;
        }
        cell.classList.add("other-month");
      } else if (dayNum > daysInMonth) {
        // дни следующего месяца
        cellDay = nextMonthDay++;
        cellMonth = month + 1;
        if (cellMonth > 11) {
          cellMonth = 0;
          cellYear = year + 1;
        }
        cell.classList.add("other-month");
      } else {
        cellDay = dayNum++;
      }

      const numberEl = document.createElement("div");
      numberEl.className = "day-number";
      numberEl.textContent = cellDay;
      cell.appendChild(numberEl);

      const key = dayKey(cellYear, cellMonth, cellDay);
      const dayEvents = events[key] || [];
      dayEvents.forEach(ev => {
        const tag = document.createElement("span");
        tag.className = "event-tag";
        const tpl = ev.templateId ? getTemplateById(ev.templateId) : null;
        if (tpl) {
          tag.style.backgroundColor = tpl.color;
        }
        const time = ev.time ? ev.time : "";
        const title = ev.title ? ev.title : "";
        tag.textContent = (time ? time + " " : "") + title;
        cell.appendChild(tag);
      });

      cell.addEventListener("click", () => {
        if (!isEditor) return;
        selectedDay = { year: cellYear, month: cellMonth, date: cellDay };
        currentDayLabelEl.textContent = formatDateLabel(cellYear, cellMonth, cellDay);
      });

      calendarGridEl.appendChild(cell);
    }
  }

  // ========= ОТРИСОВКА ТАБЛИЧНОГО ВИДА =========
  function renderTable(month, year) {
    tableBodyEl.innerHTML = "";
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const key = dayKey(year, month, day);
      const dayEvents = events[key] || [];
      const tr = document.createElement("tr");

      const tdDay = document.createElement("td");
      tdDay.className = "day-col";
      tdDay.textContent = formatDateLabel(year, month, day);
      tr.appendChild(tdDay);

      const tdEvents = document.createElement("td");
      tdEvents.className = "events-col";

      if (!dayEvents.length) {
        tdEvents.innerHTML = '<span style="color:#6b7280;font-size:12px;">нет событий</span>';
      } else {
        dayEvents
          .slice()
          .sort((a, b) => (a.time || "").localeCompare(b.time || ""))
          .forEach(ev => {
            const div = document.createElement("div");
            const tpl = ev.templateId ? getTemplateById(ev.templateId) : null;
            if (tpl) {
              div.style.borderLeft = `4px solid ${tpl.color}`;
              div.style.paddingLeft = "4px";
            }
            const timeSpan = document.createElement("span");
            timeSpan.className = "time";
            timeSpan.textContent = ev.time || "";
            const titleSpan = document.createElement("span");
            titleSpan.textContent = ev.title || "";
            const commentSpan = document.createElement("span");
            if (ev.comment) {
              commentSpan.textContent = " — " + ev.comment;
              commentSpan.style.color = "#9ca3af";
            }
            div.appendChild(timeSpan);
            div.appendChild(titleSpan);
            div.appendChild(commentSpan);
            tdEvents.appendChild(div);
          });
      }

      tr.appendChild(tdEvents);
      tableBodyEl.appendChild(tr);
    }
  }

  // ========= ПЕРЕКЛЮЧЕНИЕ ВИДОВ =========
  function setView(view) {
    if (view === "calendar") {
      calendarViewEl.style.display = "block";
      tableViewEl.style.display = "none";
      calendarViewBtn.classList.add("active");
      tableViewBtn.classList.remove("active");
    } else {
      calendarViewEl.style.display = "none";
      tableViewEl.style.display = "block";
      calendarViewBtn.classList.remove("active");
      tableViewBtn.classList.add("active");
    }
  }

  // ========= РЕЖИМ РЕДАКТОРА =========
  function updateEditorUI() {
    if (isEditor) {
      editorStatusEl.textContent = "Режим редактора включён. Можно кликать по дням и добавлять события.";
      editorBadgeEl.style.display = "inline-block";
      editorPanelEl.style.display = "block";
      editorToggleBtn.textContent = "Выйти из редактора";
    } else {
      editorStatusEl.textContent = "Режим просмотра (редактирование выключено).";
      editorBadgeEl.style.display = "none";
      editorPanelEl.style.display = "none";
      editorToggleBtn.textContent = "Войти как редактор";
      selectedDay = null;
      currentDayLabelEl.textContent = "День не выбран.";
    }
  }

  editorToggleBtn.addEventListener("click", () => {
    if (isEditor) {
      isEditor = false;
      updateEditorUI();
    } else {
      const pwd = prompt("Пароль редактора:");
      if (pwd === EDITOR_PASSWORD) {
        isEditor = true;
        updateEditorUI();
      } else if (pwd !== null) {
        alert("Неверный пароль");
      }
    }
  });

  // ========= СОХРАНЕНИЕ СОБЫТИЙ =========
  saveEventBtn.addEventListener("click", () => {
    if (!selectedDay) {
      alert("Сначала выбери день: клик по ячейке в календаре.");
      return;
    }
    const key = dayKey(selectedDay.year, selectedDay.month, selectedDay.date);
    const title = eventTitleInput.value.trim();
    const time = eventTimeInput.value;
    const comment = eventCommentInput.value.trim();
    const templateId = templateSelectEl.value || null;

    if (!title && !time && !comment) {
      alert("Нечего сохранять — заполни хотя бы одно поле.");
      return;
    }

    const arr = events[key] || [];
    arr.push({ title, time, comment, templateId });
    events[key] = arr;
    saveEvents();
    renderCalendar(currentMonth, currentYear);
    renderTable(currentMonth, currentYear);

    eventTitleInput.value = "";
    eventTimeInput.value = "";
    eventCommentInput.value = "";
  });

  clearDayBtn.addEventListener("click", () => {
    if (!selectedDay) {
      alert("Сначала выбери день.");
      return;
    }
    const key = dayKey(selectedDay.year, selectedDay.month, selectedDay.date);
    if (!events[key]) return;
    if (!confirm("Удалить все события этого дня?")) return;
    delete events[key];
    saveEvents();
    renderCalendar(currentMonth, currentYear);
    renderTable(currentMonth, currentYear);
  });

  // ========= ШАБЛОНЫ =========
  addTemplateBtn.addEventListener("click", () => {
    templateNameInput.value = "";
    templateColorInput.value = "#4b5563";
  });

  saveTemplateBtn.addEventListener("click", () => {
    const name = templateNameInput.value.trim();
    const color = templateColorInput.value;
    if (!name) {
      alert("Название шаблона не может быть пустым.");
      return;
    }
    // простой id
    const id = name.toLowerCase().replace(/\s+/g, "_") + "_" + Date.now().toString(36);
    templates.push({ id, name, color });
    saveTemplates();
    refreshTemplateSelect();
    templateSelectEl.value = id;
  });

  removeTemplateBtn.addEventListener("click", () => {
    const id = templateSelectEl.value;
    if (!id) return;
    const tpl = getTemplateById(id);
    if (!tpl) return;
    if (!confirm(`Удалить шаблон "${tpl.name}"? (События останутся, но потеряют цвет)`)) return;
    templates = templates.filter(t => t.id !== id);
    saveTemplates();
    refreshTemplateSelect();
  });

  templateSelectEl.addEventListener("change", () => {
    const tpl = getTemplateById(templateSelectEl.value);
    if (tpl && !eventTitleInput.value.trim()) {
      eventTitleInput.value = tpl.name;
    }
  });

  // ========= НАВИГАЦИЯ ПО МЕСЯЦАМ =========
  prevMonthBtn.addEventListener("click", () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    const clamped = clampYearMonth(currentYear, currentMonth);
    currentYear = clamped.year;
    currentMonth = clamped.month;
    renderCalendar(currentMonth, currentYear);
    renderTable(currentMonth, currentYear);
  });

  nextMonthBtn.addEventListener("click", () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    const clamped = clampYearMonth(currentYear, currentMonth);
    currentYear = clamped.year;
    currentMonth = clamped.month;
    renderCalendar(currentMonth, currentYear);
    renderTable(currentMonth, currentYear);
  });

  // ========= ПЕРЕКЛЮЧАТЕЛИ ВИДА =========
  calendarViewBtn.addEventListener("click", () => setView("calendar"));
  tableViewBtn.addEventListener("click", () => setView("table"));

  // ========= ИНИЦИАЛИЗАЦИЯ =========
  function init() {
    refreshTemplateSelect();
    setView("calendar");
    const clamped = clampYearMonth(currentYear, currentMonth);
    currentYear = clamped.year;
    currentMonth = clamped.month;
    renderCalendar(currentMonth, currentYear);
    renderTable(currentMonth, currentYear);
    updateEditorUI();
  }

  init();
</script>
</body>
</html>
